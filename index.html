<!DOCTYPE html>
<html>
  <head>
    <style>
      h1 {
        text-align: center;
      }
    </style>
  </head>

  <body id="body">
    <h1>O Mighty Sound Effects Lady</h1>
  </body>

  <script>
    function createAudioWidget(
      audioId,
      caption,
      { audioSource = `${audioId}.mp3`, fadeTime = 3, loop = false } = {}
    ) {
      const figure = document.createElement("figure");
      const figureCaption = document.createElement("figcaption");
      figureCaption.textContent = caption;

      const audioElement = document.createElement("audio");
      audioElement.setAttribute("controls", "");
      audioElement.setAttribute("id", audioId);
      if (loop) {
        audioElement.setAttribute("loop", "");
      }

      const sourceElement = document.createElement("source");
      sourceElement.setAttribute("src", audioSource);

      // Add the buttons too!!!!
      const fadeDownButton = document.createElement("button");
      fadeDownButton.onclick = () => fadeVolumeOnDemand(audioId, fadeTime, 0.2);
      fadeDownButton.textContent = "Fade Down";

      const fadeUpButton = document.createElement("button");
      fadeUpButton.onclick = () => fadeVolumeOnDemand(audioId, fadeTime, 1);
      fadeUpButton.textContent = "Fade Up";

      const stopButton = document.createElement("button");
      stopButton.onclick = () => stopAudio(audioId);
      stopButton.textContent = "â– ";

      audioElement.appendChild(sourceElement);
      figure.appendChild(figureCaption);
      figure.appendChild(audioElement);
      figure.appendChild(fadeDownButton);
      figure.appendChild(fadeUpButton);
      figure.appendChild(stopButton);

      const body = document.getElementById("body");
      body.appendChild(figure);
    }

    function stopAudio(audioId) {
      var audio = document.getElementById(audioId);
      audio.pause();
      audio.currentTime = 0;
    }

    function fadeVolumeOnDemand(audioId, duration, targetVolume) {
      var sound = document.getElementById(audioId);

      let numIncrements = 20;

      // Want to reach targetVolume -- if targetVolume is GREATER than volume, then we add positive increment; otherwise, we add negative increment
      var volIncrement = (targetVolume - sound.volume) / numIncrements;

      var fadeAudio = setInterval(function () {
        if (
          (volIncrement > 0 && sound.volume < targetVolume) ||
          (volIncrement < 0 && sound.volume > targetVolume)
        ) {
          // Either the increment is positive and we want to add volume until we reach the target, or increment is negative and we subtract (by adding negative) until we reach the target
          sound.volume = Math.max(Math.min(1, sound.volume + volIncrement), 0);
        } else {
          sound.volume = targetVolume;
          clearInterval(fadeAudio);
        }
      }, (duration * 1000) / numIncrements);
    }

    createAudioWidget("losing-horn", "Losing horn :(");
    createAudioWidget("main-theme", "Main theme (loop)", { loop: true });
    createAudioWidget("come-on-down", "Come on down! (loop)", { loop: true });
  </script>
</html>
